<!-- interviews/templates/candidate_interview.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Candidate Interview</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #timer { font-size: 1.2rem; font-weight: bold; color: darkred; }
    .question-card { margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h3 id="iv-title">Interview</h3>
  <div id="iv-info" class="mb-3">
    <div><strong>Scheduled:</strong> <span id="iv-scheduled">—</span></div>
    <div><strong>Duration:</strong> <span id="iv-duration">—</span> mins</div>
    <div id="timer" class="mt-2"></div>
  </div>

  <div id="iv-desc" class="mb-3"></div>

  <div id="controls">
    <button id="startAttemptBtn" class="btn btn-primary">Start Attempt</button>
    <a id="backToDash" class="btn btn-outline-secondary" href="/api/resumes/dashboard/candidate/">Back</a>
  </div>

  <form id="questionsForm" class="mt-3" style="display:none;">
    <div id="questionsContainer"></div>
    <button type="submit" class="btn btn-success">Submit Answers</button>
  </form>

  <div id="message" class="mt-3"></div>
</div>

<script>
const interviewId = "{{ interview_id }}";  // Django context
let attemptId = null;
let timerInterval = null;

// countdown
function startTimer(minutes) {
  let remaining = minutes * 60;
  const el = document.getElementById("timer");
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    el.textContent = `Time left: ${m}:${s.toString().padStart(2,'0')}`;
    if (remaining <= 0) {
      clearInterval(timerInterval);
      submitAnswers(); // auto submit
    }
    remaining--;
  }, 1000);
}

// start attempt
document.getElementById("startAttemptBtn").addEventListener("click", async () => {
  const res = await fetch(`/api/interviews/candidate/${interviewId}/start/`, {method:"POST"});
  if (!res.ok) {
    document.getElementById("message").textContent = "Failed to start attempt.";
    return;
  }
  const data = await res.json();
  attemptId = data.id || data.attempt_id;
  document.getElementById("startAttemptBtn").style.display = "none";
  loadQuestions(data.questions || []);
  startTimer(data.interview?.duration_minutes || 30);
});

// render questions
function loadQuestions(questions) {
  const container = document.getElementById("questionsContainer");
  container.innerHTML = "";
  if (!questions.length) {
    container.innerHTML = "<div class='alert alert-warning'>No questions found.</div>";
    return;
  }
  questions.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "question-card";
    let html = `<p><strong>Q${idx+1}:</strong> ${q.question_text}</p>`;
    if (q.question_type === "mcq" && q.choices) {
      for (const [opt, txt] of Object.entries(q.choices)) {
        html += `
          <div class="form-check">
            <input type="radio" class="form-check-input" name="q_${q.id}" value="${opt}">
            <label class="form-check-label">${opt}) ${txt}</label>
          </div>`;
      }
    } else {
      html += `<textarea class="form-control" name="q_${q.id}" rows="4"></textarea>`;
    }
    card.innerHTML = html;
    container.appendChild(card);
  });
  document.getElementById("questionsForm").style.display = "block";
}

// submit
document.getElementById("questionsForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  submitAnswers();
});

async function submitAnswers() {
  if (!attemptId) return;
  const form = document.getElementById("questionsForm");
  const formData = new FormData(form);
  const answers = {};
  for (const [k,v] of formData.entries()) {
    const qid = k.replace("q_","");
    answers[qid] = v;
  }
  const res = await fetch(`/api/interviews/candidate/attempts/${attemptId}/submit/`, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({answers})
  });
  if (res.ok) {
    const data = await res.json();
    document.getElementById("message").innerHTML = `<div class="alert alert-success">Submitted! Score: ${data.score} | Passed: ${data.passed}</div>`;
    document.getElementById("questionsForm").style.display = "none";
    clearInterval(timerInterval);
  } else {
    document.getElementById("message").innerHTML = `<div class="alert alert-danger">Submit failed</div>`;
  }
}
</script>
</body>
</html>
