{% extends "base.html" %}
{% load static %}

{% block title %}Candidate Dashboard{% endblock %}
<link rel="stylesheet" href="{% static 'candidate_dashboard.css' %}">

{% block extra_head %}
<style>
  /* page-specific tweaks (keeps same look as home) */
  .d-flex.gap-3{gap:1rem}
  .sidebar{width:320px;max-width:36vw}
  .main{flex:1;min-width:0}
  .job-card{cursor:pointer;padding:12px;border-radius:8px;border:1px solid #ececec;margin-bottom:8px;background:#fff}
  .d-none{display:none!important}
  #toastContainer{position:fixed;right:18px;top:18px;z-index:12000;width:320px}
  .small-muted{color:#666;font-size:.95rem}
  .resume-card{display:flex;justify-content:space-between;align-items:center}
  @media (max-width:800px){
    .sidebar{width:100%;order:2}
    .main{order:1}
  }

  /* Sidebar header / small status */
  .sidebar-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  #jwtAuthStatus { font-weight:600; font-size:0.95rem; color:#c0392b; }
  #jwtAuthStatus.not-logged-in { color:#6c757d; font-weight:600; }

  /* Invite button style */
  #viewInvitesBtn { padding:.5rem .9rem; border-radius:10px; font-size:.98rem; }

  /* compact upload card */
  .upload-card { padding:10px; border-radius:10px; }
  .upload-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
  .upload-row .btn { padding:.42rem .6rem; }

  #resumeList { margin-top:8px; }

  /* Job card layout helpers */
  .job-info { flex:1; min-width:0; }
  .job-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:220px; }

</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex gap-3 mt-3">
    <!-- LEFT sidebar -->
    <div class="sidebar">
      <!-- header: small auth status + invite button -->
      <div class="sidebar-header">
        <div id="jwtAuthStatus" aria-hidden="true"></div>
        <div style="flex:1"></div>
        <div style="width:160px">
          <button id="viewInvitesBtn" class="btn btn-primary w-100">View Invites</button>
        </div>
      </div>

    

      <div class="card upload-card mb-3">
        <label class="form-label mb-1">Upload resume</label>
        <input id="resumeFile" type="file" accept=".pdf,.doc,.docx" class="form-control form-control-sm" />
        <div class="upload-row">
          <button id="uploadBtn" class="btn btn-sm btn-primary">Upload</button>
          <button id="refreshResumesBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
        <div id="tokenStatus" class="small-muted mt-2"></div>
      </div>

      <div id="resumeList" class="mb-3" style="max-height:28vh;overflow:auto;padding:8px;border-radius:8px;background:#fff;border:1px solid #eee">
        <!-- resumes injected -->
      </div>

      <div class="card p-2" style="background:#fff;border:1px solid #eee">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <small class="small-muted">My applications</small>
          <div class="d-flex gap-2">
            <button id="refreshMyAppsBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
            <button id="exportMyAppsBtn" class="btn btn-sm btn-outline-dark">Export CSV</button>
          </div>
        </div>
        <div id="myApplicationsList" style="max-height:22vh;overflow:auto;margin-top:8px"></div>
      </div>
    </div>

    <!-- RIGHT main -->
       <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 style="margin:0">Jobs</h5>
        <div>
          <button id="refreshJobs" class="btn btn-sm btn-outline-secondary">Refresh</button>
       
    <div class="main">
      <div id="noJob" class="alert alert-secondary">Select a job to see details</div>

      <div id="jobDetails" class="card p-3 mb-3 d-none" style="background:#fff;border:1px solid #eee">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h4 id="selectedJobTitle" style="margin:0">Job title</h4>
            <div id="jobMeta" class="small-muted">Company • Experience • Location</div>
          </div>
          <div>
            <button id="showMatchesBtn" class="btn btn-sm btn-outline-primary">Matches</button>
            <button id="showShortlistsBtn" class="btn btn-sm btn-outline-success">Shortlists</button>
            <button id="refreshApplicationsBtn" class="btn btn-sm btn-outline-secondary">Applications</button>
          </div>
        </div>
        

        <hr />

        <div id="matchesSection" style="display:none" class="mb-3">
          <h6 style="margin:0 0 8px 0">Matches</h6>
          <div id="matchesList"></div>
        </div>

        <div id="applicationsSection" style="display:none" class="mb-3">
          <h6 style="margin:0 0 8px 0">Applications</h6>
          <div id="applicationsList"></div>
        </div>

        <div id="shortlistSection" style="display:none" class="mb-3">
          <h6 style="margin:0 0 8px 0">Shortlist</h6>
          <div id="shortlistList"></div>
        </div>
      </div>

      <!-- Invites Section (inline) -->
      <div id="invitesSection" class="card p-3 mb-3" style="background:#fff;border:1px solid #eee; display:none;">
        <h6 style="margin:0 0 8px 0">Your Invites</h6>
        <div id="invitesList"></div>
      </div>

      <!-- Jobs list -->
      <div id="jobsList" style="background:#fff;padding:8px;border-radius:8px;border:1px solid #eee;max-height:64vh;overflow:auto">
        <!-- job cards injected here by JS -->
      </div>
    </div>
  </div>
</div>

<!-- Invite Modal (unique modal container) -->
<div class="modal fade" id="invitesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Invites</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-3">
        <div id="invitesModalAlert" style="display:none" class="mb-2"></div>
        <div id="invitesListModal">
          <div class="text-muted small">Loading invites...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="invitesModalClose" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="invitesModalRefresh" type="button" class="btn btn-primary">Refresh</button>
      </div>
    </div>
  </div>
</div>

<!-- Apply Modal -->
<div id="applyModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <form id="applyForm">
        <div class="modal-header">
          <h5 class="modal-title">Apply for job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Choose resume</label>
            <select id="applyResumeSelect" class="form-select"></select>
          </div>
          <div class="mb-2">
            <label class="form-label">Message (optional)</label>
            <textarea id="applyMessage" class="form-control" rows="3"></textarea>
          </div>
          <div class="small-muted">Note: If apply fails, JS retries with FormData fallback.</div>
        </div>
        <div class="modal-footer">
          <button id="applyCancelBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="applySubmitBtn" type="submit" class="btn btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Attempts modal -->
<div id="attempts-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:99999">
  <div style="width:900px;max-width:96%;background:#fff;border-radius:8px;padding:16px;border:1px solid #eee;max-height:80vh;overflow:auto;position:relative">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h5 id="attempts-modal-title" style="margin:0">Attempt history</h5>
      <div><button id="attempts-modal-close" class="btn btn-sm btn-outline-secondary">Close</button></div>
    </div>
    <div id="attempts-loading" style="margin-top:12px">Loading attempts…</div>
    <div id="attempts-list" style="margin-top:12px;display:none"></div>
    <div style="margin-top:12px;text-align:right"><button id="attempts-modal-ok" class="btn btn-primary">OK</button></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- page script -->
<script type="module" src="{% static 'candidate_dashboard.js' %}"></script>

<!-- small UI sanity script: hide invites for anonymous & show subtle status -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const userId = document.body.dataset.userId || '';
    const jwtEl = document.getElementById('jwtAuthStatus');
    const invitesBtn = document.getElementById('viewInvitesBtn');
    if (!userId) {
      if (jwtEl) { jwtEl.classList.add('not-logged-in'); jwtEl.textContent = 'Not logged in'; }
      if (invitesBtn) invitesBtn.style.display = 'none';
    } else {
      if (jwtEl && jwtEl.textContent.trim()==='') jwtEl.textContent = 'Logged in';
      if (invitesBtn) invitesBtn.style.display = '';
    }
  });
</script>
{% endblock %}
