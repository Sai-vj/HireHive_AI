<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Candidate Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{padding:20px}
    .small-muted{font-size:.85rem;color:#666}
    .card-file{display:flex;align-items:center;justify-content:space-between}
    .spinner{display:inline-block;width:1rem;height:1rem;border:.15rem solid #eee;border-top-color:#0d6efd;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-3">Candidate Dashboard</h1>

  <!-- Token -->
  <div class="mb-4">
    <label class="form-label">Bearer token (paste your JWT access token)</label>
    <input id="tokenInput" class="form-control" placeholder="Paste token here">
    <div class="form-text">Token is stored in localStorage for this demo only.</div>
    <button id="saveTokenBtn" class="btn btn-sm btn-primary mt-2">Save token</button>
  </div>

  <div class="row">
    <!-- Left: Upload + Resumes -->
    <div class="col-md-6">
      <div class="card mb-3 p-3">
        <h5 class="card-title">Upload Resume</h5>
        <form id="uploadForm">
          <div class="mb-2">
            <input id="resumeFile" type="file" class="form-control" accept=".pdf,.doc,.docx" />
          </div>
          <button class="btn btn-primary" type="submit">Upload</button>
          <div id="uploadResult" class="mt-3"></div>
        </form>
      </div>

      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Your Resumes</h5>
          <div>
            <button id="refreshResumes" class="btn btn-sm btn-outline-secondary">Refresh</button>
          </div>
        </div>
        <div id="resumesList" class="mt-3">Loading...</div>
      </div>
    </div>

    <!-- Right: Shortlists -->
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Your Shortlists</h5>
          <button id="refreshShortlists" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
        <div id="shortlistList" class="mt-3">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---- helpers ----
  function getToken(){ return localStorage.getItem('token') || document.getElementById('tokenInput').value.trim(); }
  function authHeaders(){ const t=getToken(); return t? {'Authorization': 'Bearer ' + t}: {}; }
  function showMsg(el, html, cls='alert-success'){ el.innerHTML = `<div class="alert ${cls} py-1 my-1">${html}</div>`; setTimeout(()=>{ el.innerHTML=''; }, 5000); }
  async function apiFetch(path, opts = {}) {
    opts.headers = opts.headers || {};
    Object.assign(opts.headers, authHeaders());
    const resp = await fetch(path, opts);
    const text = await resp.text();
    let json = null;
    try { json = text? JSON.parse(text): null } catch(e){ json = text }
    return { ok: resp.ok, status: resp.status, data: json, raw: text };
  }

  // ---- token save ----
  document.getElementById('saveTokenBtn').addEventListener('click', ()=>{
    const v = document.getElementById('tokenInput').value.trim();
    if(!v){ alert('Paste token first'); return; }
    localStorage.setItem('token', v); alert('Token saved');
    // auto-refresh lists
    loadMyResumes(); loadShortlists();
  });

  // ---- upload resume ----
  document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const out = document.getElementById('uploadResult');
    const f = document.getElementById('resumeFile').files[0];
    if(!f){ showMsg(out, 'Choose file first', 'alert-danger'); return; }

    const form = new FormData(); form.append('file', f);
    // show spinner
    out.innerHTML = `<div class="small-muted"><span class="spinner"></span> Uploading...</div>`;
    const headers = authHeaders(); // do NOT set Content-Type, browser handles for FormData
    try{
      const resp = await fetch('/api/resumes/upload/', { method:'POST', headers, body: form });
      const text = await resp.text();
      let data = null;
      try { data = text? JSON.parse(text): null } catch(e){ data = text; }
      if(resp.ok){
        showMsg(out, `Uploaded — id ${data.id}`, 'alert-success');
        document.getElementById('resumeFile').value = '';
        loadMyResumes();
      } else {
        showMsg(out, `Upload failed: ${data?.detail || data || resp.status}`, 'alert-danger');
      }
    }catch(err){
      console.error(err);
      showMsg(out, 'Upload error (network)', 'alert-danger');
    }
  });

  // ---- load my resumes ----
  async function loadMyResumes(){
    const c = document.getElementById('resumesList');
    c.innerHTML = `<div class="small-muted"><span class="spinner"></span> Loading...</div>`;
    const res = await apiFetch('/api/resumes/my-resumes/');
    if(!res.ok){
      c.innerHTML = `<div class="text-danger">Error: ${res.data?.detail || res.status}</div>`;
      return;
    }
    const list = res.data || [];
    if(list.length===0){
      c.innerHTML = `<div class="text-muted">No resumes uploaded yet.</div>`;
      return;
    }
    c.innerHTML = '';
    list.forEach(r=>{
      const fileLink = r.file ? `<a href="${r.file}" target="_blank">Download</a>` : '';
      const skills = r.skills || '';
      const exp = r.experience || '';
      const uploaded = r.uploaded_at || '';
      const card = document.createElement('div');
      card.className = 'card mb-2 p-2';
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>Resume #${r.id}</strong> ${fileLink ? ` • ${fileLink}` : ''}
            <div class="small-muted">skills: ${skills}</div>
            <div class="small-muted">experience: ${exp}</div>
            <div class="small-muted">uploaded: ${uploaded}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteResume(${r.id})">Remove</button>
          </div>
        </div>`;
      c.appendChild(card);
    });
  }

  // ---- delete resume ----
  async function deleteResume(id){
    if(!confirm('Remove resume? This cannot be undone.')) return;
    const t = getToken();
    if(!t){ alert('Missing token'); return; }
    const headers = {'Authorization': 'Bearer ' + t};
    try{
      const resp = await fetch(`/api/resumes/my-resumes/${id}/`, { method:'DELETE', headers });
      const text = await resp.text();
      let data=null; try{ data = text? JSON.parse(text): null }catch(e){ data = text; }
      if(!resp.ok){
        alert('Delete failed: ' + (data?.error || data?.detail || resp.status));
        return;
      }
      alert('Resume removed');
      loadMyResumes();
      loadShortlists(); // refresh shortlists in case
    }catch(err){
      console.error(err); alert('Delete failed (network)');
    }
  }

  // ---- load shortlists ----
  async function loadShortlists(){
    const c = document.getElementById('shortlistList');
    c.innerHTML = `<div class="small-muted"><span class="spinner"></span> Loading...</div>`;
    const res = await apiFetch('/api/resumes/my-shortlists/');
    if(!res.ok){
      c.innerHTML = `<div class="text-danger">Error: ${res.data?.detail || res.status}</div>`;
      return;
    }
    const list = res.data || [];
    if(list.length===0){
      c.innerHTML = `<div class="text-muted">No shortlist notifications yet.</div>`;
      return;
    }
    c.innerHTML = '';
    list.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'card mb-2 p-2';
      const emailSent = s.email_sent ? `email_sent: true ${s.email_sent_at ? ' at '+s.email_sent_at : ''}` : 'email_sent: false';
      card.innerHTML = `
        <div><strong>${s.job.title}</strong></div>
        <div class="small-muted">Shortlisted on ${s.created_at}</div>
        <div class="small-muted">${emailSent}</div>
      `;
      c.appendChild(card);
    });
  }

  // ---- wire refresh buttons and init ----
  document.getElementById('refreshResumes').addEventListener('click', loadMyResumes);
  document.getElementById('refreshShortlists').addEventListener('click', loadShortlists);

  (function init(){
    const saved = localStorage.getItem('token');
    if(saved) document.getElementById('tokenInput').value = saved;
    // auto-load if token available
    if(getToken()){
      loadMyResumes();
      loadShortlists();
    } else {
      document.getElementById('resumesList').innerHTML = '<div class="text-muted">Paste token and click Save token to view your resumes.</div>';
      document.getElementById('shortlistList').innerHTML = '<div class="text-muted">Paste token and click Save token to view your shortlists.</div>';
    }
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
