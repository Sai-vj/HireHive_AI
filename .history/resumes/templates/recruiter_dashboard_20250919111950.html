<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruiter Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding:20px; background:#f7f7f9; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; }
    .sidebar { width:320px; max-width:38vw; }
    .main { flex:1; min-width:0; }
    .job-card { cursor:pointer; padding:12px; border-radius:8px; border:1px solid #ececec; margin-bottom:8px; background:#fff; }
    #jobDetails { display:none; }
    .d-none { display:none!important; }
    #toastContainer { position:fixed; right:18px; top:18px; z-index:12000; width:320px; max-width:calc(100% - 40px); }
    .small-muted { color:#666; font-size:.95rem; }
    /* modal center */
    .invite-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:99998; }
    .invite-card { width:720px; max-width:96%; background:#fff; border-radius:10px; padding:16px; border:1px solid #eee; }
  </style>
</head>
<body>
  <div id="toastContainer"></div>

  <div class="d-flex gap-3">
    <!-- LEFT: jobs list -->
    <div class="sidebar">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 style="margin:0">Jobs</h5>
        <div>
          <button id="refreshJobs" class="btn btn-sm btn-outline-secondary">Refresh</button>
          <button id="addJobBtn" class="btn btn-sm btn-primary">Add</button>
        </div>
      </div>
      <div id="jobsList" class="mb-3" style="max-height:70vh;overflow:auto;background:#fff;padding:8px;border-radius:8px;border:1px solid #eee">
      </div>

      <div class="card p-2" style="background:#fff;border:1px solid #eee">
        <label class="form-label mb-1">Token</label>
        <div class="d-flex gap-2">
          <input id="tokenInput" class="form-control form-control-sm" placeholder="Paste recruiter token" />
          <button id="saveTokenBtn" class="btn btn-sm btn-success">Save</button>
        </div>
        <div id="tokenStatus" style="margin-top:6px;font-size:.9rem;color:#4b5563"></div>
      </div>
    </div>

    <!-- RIGHT: job details / panels -->
    <div class="main">
      <div id="noJob" class="alert alert-secondary">Select a job to view details</div>

      <div id="jobDetails" class="card p-3 mb-3" style="background:#fff;border:1px solid #eee">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h4 id="selectedJobTitle" style="margin:0">Job title</h4>
            <div id="jobMeta" class="small-muted">meta</div>
          </div>
          <div>
            <button id="showMatchesBtn" class="btn btn-sm btn-outline-primary">Matches</button>
            <button id="showApplicationsBtn" class="btn btn-sm btn-outline-secondary">Applications</button>
            <button id="showShortlistsBtn" class="btn btn-sm btn-outline-success">Shortlists</button>
            <button id="exportCsvBtn" class="btn btn-sm btn-outline-dark">Export CSV</button>
          </div>
        </div>

        <hr/>

        <div id="applicationsSection" class="mb-3" style="display:none">
          <h6 style="margin:0 0 8px 0">Applications</h6>
          <div id="applicationsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite Modal (shared) -->
  <div id="inviteModal" class="invite-overlay d-none" aria-hidden="true">
    <div class="invite-card" role="dialog" aria-modal="true" aria-labelledby="inviteModalTitle">
      <h5 id="inviteModalTitle" style="margin:0 0 8px 0">Invite candidate</h5>

      <!-- hidden interview id if available -->
      <input type="hidden" id="invite_interview_id" />

      <div class="mb-2">
        <label class="form-label">Candidate ID</label>
        <input id="invite_candidate_id" class="form-control" autocomplete="off" />
      </div>

      <div class="mb-2">
        <label class="form-label">Schedule at</label>
        <input id="invite_scheduled_at" type="datetime-local" class="form-control" />
      </div>

      <div class="mb-2">
        <label class="form-label">Message</label>
        <textarea id="invite_message" class="form-control" rows="3">Hi, you are invited for interview.</textarea>
      </div>

      <div class="text-end">
        <button id="inviteCancelBtn" class="btn btn-sm btn-outline-secondary">Cancel</button>
        <button id="inviteSendBtn" class="btn btn-sm btn-success">Send Invite</button>
      </div>
    </div>
  </div>

  <script>
  /*****************************************************************************
   * Bridge script for invite modal
   * - When any element with class `.invite-btn` is clicked this opens modal
   * - If your external module exposes window.showInviteModal(data) it will call that
   * - Otherwise the inline send will POST to /api/interviews/recruiter/job/{jobId}/invite/
   *****************************************************************************/

  (function(){
    // DOM refs
    const overlay = document.getElementById('inviteModal');
    const inputCandidate = document.getElementById('invite_candidate_id');
    const inputScheduled = document.getElementById('invite_scheduled_at');
    const inputMessage = document.getElementById('invite_message');
    const inputInterviewId = document.getElementById('invite_interview_id');
    const sendBtn = document.getElementById('inviteSendBtn');
    const cancelBtn = document.getElementById('inviteCancelBtn');

    if (!overlay) return console.warn('inviteModal missing');

    // helper show/hide
    function showModal({ jobId = null, interviewId = null, candidateId = '', candidateName = '' } = {}) {
      // If external controller exists, call it (preferred)
      if (typeof window.showInviteModal === 'function') {
        // pass object to the external controller
        try {
          window.showInviteModal({ jobId, candidateId, candidateName });
          return;
        } catch (e) {
          console.warn('window.showInviteModal failed, falling back to inline modal', e);
        }
      }

      // fallback: open inline modal and fill fields
      inputInterviewId && (inputInterviewId.value = interviewId || jobId || '');
      inputCandidate && (inputCandidate.value = candidateId || '');
      inputScheduled && (inputScheduled.value = '');
      inputMessage && (inputMessage.value = `Hi ${candidateName || ''}, you are invited for interview.`);
      overlay.classList.remove('d-none');
      overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function hideModal() {
      // if external hide exists call it
      if (typeof window.hideInviteModal === 'function') {
        try { window.hideInviteModal(); return; } catch(e){ /* continue fallback */ }
      }
      overlay.classList.add('d-none');
      overlay.style.display = 'none';
      document.body.style.overflow = '';
    }

    // delegated click: any .invite-btn in page
    document.body.addEventListener('click', function(ev){
      const btn = ev.target.closest && ev.target.closest('.invite-btn');
      if (!btn) return;
      ev.preventDefault();

      // read attributes (support data- attributes)
      const interviewId = btn.dataset.interviewId || btn.getAttribute('data-interview-id') || null;
      const jobId = btn.dataset.jobId || btn.getAttribute('data-job-id') || null;
      const candidateId = btn.dataset.candidateId || btn.getAttribute('data-candidate-id') || '';
      const candidateName = btn.dataset.candidateName || btn.getAttribute('data-candidate-name') || '';

      // prefer jobId if available (server endpoints expect job id in url)
      const effectiveJobId = jobId || interviewId || null;

      showModal({ jobId: effectiveJobId, interviewId, candidateId, candidateName });
    });

    // click outside to close (overlay)
    overlay.addEventListener('click', function(e){
      if (e.target === overlay) hideModal();
    });

    // esc to close
    window.addEventListener('keydown', function(e){ if (e.key === 'Escape') hideModal(); });

    if (cancelBtn) cancelBtn.addEventListener('click', function(e){ e.preventDefault(); hideModal(); });

    // inline send handler (fallback if your external module doesn't implement sending)
    if (sendBtn) sendBtn.addEventListener('click', async function(e){
      e.preventDefault();
      // If external send function exists, call it to keep single behavior
      if (typeof window.sendInvite === 'function') {
        try {
          await window.sendInvite(); // your external sendInvite should handle field reading
          hideModal();
          return;
        } catch (err) {
          console.error('external sendInvite failed', err);
          alert('Invite failed (external). See console for details.');
          return;
        }
      }

      // Fallback send: POST to /api/interviews/recruiter/job/{jobId}/invite/
      const jobIdFromHidden = document.getElementById('invite_interview_id') && document.getElementById('invite_interview_id').value;
      // if jobIdFromHidden blank, ask user for job id
      const jobId = jobIdFromHidden || prompt('Job id to invite for (enter job id):');
      if (!jobId) { alert('Job id required'); return; }

      const candidate_id = (inputCandidate && inputCandidate.value || '').trim();
      if (!candidate_id) { alert('Enter candidate id'); return; }

      const scheduled_at = inputScheduled && inputScheduled.value ? new Date(inputScheduled.value).toISOString() : null;
      const message = inputMessage && inputMessage.value ? inputMessage.value.trim() : '';

      const token = localStorage.getItem('token') || '';
      const url = `/api/interviews/recruiter/job/${jobId}/invite/`;

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: Object.assign({'Content-Type': 'application/json'}, token ? {'Authorization': `Bearer ${token}`} : {}),
          body: JSON.stringify({ candidate_id, scheduled_at, message })
        });
        const text = await res.text();
        let json;
        try { json = text ? JSON.parse(text) : null; } catch(e){ json = text; }
        if (res.ok || res.status === 201) {
          alert('Invite sent successfully');
          hideModal();
          // optionally refresh application list by calling a window.refreshApplications if exposed
          if (typeof window.refreshApplications === 'function') {
            try { window.refreshApplications(); } catch(e){ /* ignore */ }
          }
        } else {
          const errMsg = (json && (json.detail || JSON.stringify(json))) || `Failed (${res.status})`;
          alert('Invite failed: ' + errMsg);
          console.error('invite failed', res.status, json);
        }
      } catch (err) {
        console.error('network invite error', err);
        alert('Network error while sending invite');
      }
    });

    // expose simple helpers if needed by other scripts
    window._invite_bridge = {
      show: (opts) => showModal(opts),
      hide: () => hideModal()
    };
  })();
  </script>

  <!-- bootstrap and optional recruiter_dashboard.js module (if you have it) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- If you have your external module (recommended), include it here.
       If you removed it earlier, keep this line commented or remove it.
  -->
  <script type="module" src="/static/recruiter_dashboard.js"></script>
</body>
</html>