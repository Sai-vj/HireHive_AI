<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interview</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4" style="background:#f6f7fb">
  <div class="container">
    <div id="interviewMain" class="card p-4">
      <h3 id="interviewTitle">Interview</h3>
      <div id="interviewMeta" class="small-muted mb-2"></div>
      <div id="interviewDescription" style="white-space:pre-wrap;margin-bottom:12px"></div>
      <div id="interviewActions" class="mb-3">
        <button id="startBtn" class="btn btn-primary">Start Interview</button>
      </div>
      <div id="interviewContent" style="display:none">
        <!-- load questions, timer, attempt info here or redirect to quiz -->
      </div>
    </div>
  </div>

  <script>
  // simple inline script to bootstrap the page
  (function(){
    const parts = window.location.pathname.split('/');
    // assume '/interviews/candidate/<id>/' or similar
    const id = parts.filter(Boolean).pop();
    if (!id) { document.getElementById('interviewMain').innerText = 'Missing interview id'; return; }

    const token = localStorage.getItem('token') || '';
    function headers(){ const h = {'Content-Type':'application/json'}; if (token) h['Authorization'] = 'Bearer ' + token; return h; }

    async function fetchInterview() {
      const r = await fetch(`/api/interviews/candidate/${id}/`, { method:'GET', headers: headers() });
      if (!r.ok) {
        const txt = await r.text().catch(()=>null);
        document.getElementById('interviewMain').innerHTML = `<div class="text-danger">Failed to load interview: ${r.status} ${txt||''}</div>`;
        return;
      }
      const data = await r.json().catch(()=>null) || {};
      document.getElementById('interviewTitle').textContent = data.title || `Interview ${id}`;
      document.getElementById('interviewMeta').textContent = `Scheduled: ${data.scheduled_at || '—'} • Duration: ${data.duration_minutes || '—'} mins • Mode: ${data.mode || '—'}`;
      document.getElementById('interviewDescription').textContent = data.description || data.instructions || '';
      // if already has attempt or state, optionally show Start disabled
      if (data.started || data.attempt_open) {
        document.getElementById('startBtn').textContent = 'Resume Interview';
      }
    }

    async function startAttempt(){
      const btn = document.getElementById('startBtn');
      btn.disabled = true;
      btn.textContent = 'Starting…';
      try {
        const r = await fetch(`/api/interviews/candidate/${id}/start/`, { method:'POST', headers: headers() });
        const txt = await r.text().catch(()=>null);
        let json = null;
        try { json = txt ? JSON.parse(txt) : null; } catch(e){ json = null; }
        if (!r.ok) {
          alert('Failed to start: ' + (json?.detail || r.status));
          btn.disabled = false; btn.textContent = 'Start Interview';
          return;
        }
        // backend should return attempt object (id) or quiz payload
        // Decide: redirect to quiz page or render questions here
        // If you have a quiz page like /quiz/attempt/<attempt_id>/ do:
        const attemptId = json?.attempt_id || json?.id || json?.attempt || null;
        if (attemptId) {
          // redirect to attempt view or quiz UI page
          window.location.href = `/interviews/attempt/${attemptId}/`; // adjust to your routing
        } else if (json?.questions) {
          // render questions inline or call your quiz modal
          // For quick flow, open quiz modal if available
          if (window.openQuizModal) {
            window.openQuizModal(Number(id), json.questions);
          } else {
            document.getElementById('interviewContent').style.display = 'block';
            document.getElementById('interviewContent').innerHTML = '<pre>' + JSON.stringify(json, null, 2) + '</pre>';
          }
        } else {
          // fallback: refresh page
          location.reload();
        }
      } catch (e) {
        console.error(e);
        alert('Network error while starting interview');
        document.getElementById('startBtn').disabled = false; document.getElementById('startBtn').textContent = 'Start Interview';
      }
    }

    document.getElementById('startBtn').addEventListener('click', startAttempt);

    fetchInterview();
  })();
  </script>
</body>
</html>
